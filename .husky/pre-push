#!/usr/bin/env sh

# Husky pre-push hook: sync HA -> repo before pushing
# Requires env: HA_HOST, HA_SSH_USER, HA_SSH_KEY (optionally HA_SSH_PORT)
# Optional env: HA_PREPUSH_MODE=gui|components|full (default: gui)

# Load .env.local if present (to get HA_* values)
if [ -f ".env.local" ]; then
  set -a
  . ./.env.local
  set +a
fi

MODE="${HA_PREPUSH_MODE:-gui}"

run_sync() {
  case "$MODE" in
    gui)
      scripts/pull_gui_changes.sh ;;
    components)
      scripts/sync_from_ha.sh --components-only --into-config ;;
    full)
      scripts/sync_from_ha.sh --into-config ;;
    *)
      echo "[husky pre-push] Unknown HA_PREPUSH_MODE: $MODE" >&2
      exit 2 ;;
  esac
}

# Only run sync if HA env is configured
if [ -n "${HA_HOST}" ] && [ -n "${HA_SSH_USER}" ] && [ -n "${HA_SSH_KEY}" ]; then
  echo "[husky pre-push] HA sync (mode=${MODE})"
  run_sync
  # If sync produced changes, auto-commit and abort push
  if [ -n "$(git status --porcelain)" ]; then
    git add -A
    git commit -m "chore(sync): import HA changes ($(date +%Y-%m-%dT%H:%M:%S))" || true
    echo "[husky pre-push] Changes committed. Aborting push. Re-run 'git push'."
    exit 1
  fi
else
  echo "[husky pre-push] Skipping HA sync (HA env not configured)."
fi

exit 0

