name: CI

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  validate-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PyYAML for secrets validation
        run: pip install pyyaml

      - name: Create secrets.yaml for validation
        run: |
          cat > config/secrets.yaml << 'EOF'
          # Auto-generated secrets for CI validation
          strava_client_id: ${{ secrets.STRAVA_CLIENT_ID || 'test_strava_client_id' }}
          strava_client_secret: ${{ secrets.STRAVA_CLIENT_SECRET || 'test_strava_client_secret' }}
          tuya_client_id: ${{ secrets.TUYA_CLIENT_ID || 'test_value' }}
          tuya_client_secret: ${{ secrets.TUYA_CLIENT_SECRET || 'test_value' }}
          tuya_user_id: test_value
          tuya_country_code: 48
          xiaomi_username: ${{ secrets.XIAOMI_USERNAME || 'test@example.com' }}
          xiaomi_password: ${{ secrets.XIAOMI_PASSWORD || 'test_value' }}
          aqara_app_id: test_value
          aqara_app_key: test_value
          aqara_key_id: test_value
          daikin_onecta_client_id: ${{ secrets.DAIKIN_ONECTA_CLIENT_ID || 'test_value' }}
          daikin_onecta_client_secret: ${{ secrets.DAIKIN_ONECTA_CLIENT_SECRET || 'test_value' }}
          solarman_app_id: ${{ secrets.SOLARMAN_APP_ID || 'test_value' }}
          solarman_app_secret: ${{ secrets.SOLARMAN_APP_SECRET || 'test_value' }}
          solarman_username: test@example.com
          solarman_password: test_value
          mqtt_broker: mqtt.example.com
          mqtt_port: 1883
          mqtt_username: ${{ secrets.MQTT_USERNAME || 'test_user' }}
          mqtt_password: ${{ secrets.MQTT_PASSWORD || 'test_value' }}
          mqtt_client_id: homeassistant
          tauron_username: ${{ secrets.TAURON_USERNAME || 'test@example.com' }}
          tauron_password: ${{ secrets.TAURON_PASSWORD || 'test_value' }}
          elicznik_username: ${{ secrets.ELICZNIK_USERNAME || 'test@example.com' }}
          elicznik_password: ${{ secrets.ELICZNIK_PASSWORD || 'test_value' }}
          bluesecure_host: 192.168.1.100
          bluesecure_username: admin
          bluesecure_password: test_value
          tech_user_id: test_value
          tech_token: test_value
          home_latitude: 52.2297
          home_longitude: 21.0122
          home_elevation: 100
          telegram_bot_token: test_value
          telegram_chat_id: test_value
          openweathermap_api_key: test_value
          http_password: test_value
          EOF

      - name: Validate secret references
        run: |
          python scripts/validate_secrets.py --verbose

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker images
        uses: actions/cache@v5
        with:
          path: /tmp/.docker-cache
          key: ${{ runner.os }}-ha-docker-2024.11.3
          restore-keys: |
            ${{ runner.os }}-ha-docker-

      - name: Pull Home Assistant Docker image
        run: |
          # Pin to specific version for reproducibility
          HA_VERSION="2024.11.3"
          echo "Using Home Assistant version: ${HA_VERSION}"

          docker pull ghcr.io/home-assistant/home-assistant:${HA_VERSION}

          # Also tag as 'stable' for local reference
          docker tag ghcr.io/home-assistant/home-assistant:${HA_VERSION} \
            ghcr.io/home-assistant/home-assistant:stable

      - name: Validate Home Assistant configuration
        run: |
          docker run --rm \
            -v "$PWD/config":/config \
            ghcr.io/home-assistant/home-assistant:stable \
            python -m homeassistant --script check_config --config /config

      - name: Upload config snapshot as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: config-snapshot-${{ github.sha }}
          path: |
            config/
            !config/.storage/
            !config/home-assistant_v2.db*
            !config/*.db
            !config/*.db-shm
            !config/*.db-wal
            !config/deps/
            !config/tts/
            !config/.cloud/
            !config/backups/
          retention-days: 30

  test-root-project:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: |
          pip install -e .[test]

      - name: Run tests with coverage
        run: |
          # Run infrastructure tests (config validation, automation tests, etc.)
          # Custom component unit tests will be added in future iterations
          pytest --cov=scripts --cov-report=xml --cov-report=html --cov-report=term

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          flags: root-project
          name: root-project-coverage
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-root
          path: htmlcov/
          retention-days: 30

      - name: Check coverage threshold
        run: |
          # Lower threshold for infrastructure testing phase
          # Currently measuring config/automation tests (no script execution yet)
          # Will add script tests and increase threshold in future iterations
          coverage report --fail-under=0 || echo "::warning::Coverage below target (current: $(coverage report | grep TOTAL | awk '{print $NF}'), target: 30%)"

  test-custom-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install test deps
        working-directory: ha-strava-coach
        run: |
          pip install -e .[test]
      - name: Run tests with coverage
        working-directory: ha-strava-coach
        run: pytest --cov --cov-report=xml --cov-report=term

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./ha-strava-coach/coverage.xml
          flags: strava-coach
          name: strava-coach-coverage
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  lint-yaml:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install yamllint
        run: pip install yamllint
      - name: Lint YAML files
        run: yamllint config/

  lint-shell:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          find scripts/ -name "*.sh" -type f -exec shellcheck {} +
