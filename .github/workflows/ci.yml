name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  validate-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Home Assistant configuration check
        uses: frenck/action-home-assistant@v2
        with:
          path: ./config
          secrets: |
            tuya_client_id=${{ secrets.TUYA_CLIENT_ID }}
            tuya_client_secret=${{ secrets.TUYA_CLIENT_SECRET }}
            xiaomi_username=${{ secrets.XIAOMI_USERNAME }}
            xiaomi_password=${{ secrets.XIAOMI_PASSWORD }}
            daikin_onecta_client_id=${{ secrets.DAIKIN_ONECTA_CLIENT_ID }}
            daikin_onecta_client_secret=${{ secrets.DAIKIN_ONECTA_CLIENT_SECRET }}
            solarman_app_id=${{ secrets.SOLARMAN_APP_ID }}
            solarman_app_secret=${{ secrets.SOLARMAN_APP_SECRET }}
            mqtt_broker=${{ secrets.MQTT_BROKER }}
            mqtt_username=${{ secrets.MQTT_USERNAME }}
            mqtt_password=${{ secrets.MQTT_PASSWORD }}
            tauron_username=${{ secrets.TAURON_USERNAME }}
            tauron_password=${{ secrets.TAURON_PASSWORD }}
            elicznik_username=${{ secrets.ELICZNIK_USERNAME }}
            elicznik_password=${{ secrets.ELICZNIK_PASSWORD }}

      - name: Upload config snapshot as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: config-snapshot-${{ github.sha }}
          path: |
            config/
            !config/.storage/
            !config/home-assistant_v2.db*
            !config/*.db
            !config/*.db-shm
            !config/*.db-wal
            !config/deps/
            !config/tts/
            !config/.cloud/
            !config/backups/
          retention-days: 30

  test-custom-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install test deps
        run: |
          pip install -e .[test]
      - name: Run tests
        run: pytest -q
