services:
  # PostgreSQL with pgvector for AI memory
  postgres:
    image: pgvector/pgvector:pg16
    container_name: ai-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ai_assistant
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}  # Fallback if secrets disabled
      # POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password  # Use secret when SECRETS_MANAGER_ENABLED=true
      POSTGRES_DB: ai_assistant
    # secrets:  # Disabled for local dev (no /run/secrets on macOS)
    #   - postgres_password
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ai_assistant"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Home Assistant (Optional - can run from separate home-assistant-service repo)
  # To use external HA: don't include 'ha' profile, set HA_BASE_URL to external address
  # To use embedded HA: docker compose --profile ha up -d
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:2025.11.3
    container_name: homeassistant
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_ADMIN
    volumes:
      - ${HA_CONFIG_PATH:-../home-assistant-service/config}:/config
      - /var/run/docker.sock:/var/run/docker.sock
      - /run/dbus:/run/dbus:rw  # Bluetooth support via D-Bus (read-write)
    environment:
      - TZ=${TZ:-Europe/Warsaw}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/manifest.json"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    profiles:
      - ha

  # MQTT Broker (Mosquitto)
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./data/mosquitto/config:/mosquitto/config
      - ./data/mosquitto/data:/mosquitto/data
      - ./data/mosquitto/log:/mosquitto/log
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 30s
      timeout: 10s
      retries: 3

  # AI Gateway
  ai-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-gateway
    ports:
      - "8080:8080"
    environment:
      # Security: Enable Docker Secrets (Phase 1 - disabled by default)
      - SECRETS_MANAGER_ENABLED=${SECRETS_MANAGER_ENABLED:-false}
      # Home Assistant connection
      - HA_TOKEN=${HA_TOKEN}  # Fallback if secrets disabled
      - HA_BASE_URL=${HA_BASE_URL:-http://host.docker.internal:8123}
      # LLM Provider selection (ollama or openai)
      - LLM_PROVIDER=${LLM_PROVIDER:-ollama}
      # Ollama configuration (used when LLM_PROVIDER=ollama)
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen2.5:3b}
      # OpenAI configuration (used when LLM_PROVIDER=openai)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}  # Fallback if secrets disabled
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      # STT Provider selection (vosk or whisper)
      - STT_PROVIDER=${STT_PROVIDER:-vosk}
      - WHISPER_MODEL=${WHISPER_MODEL:-small}
      - STT_CONFIDENCE_THRESHOLD=${STT_CONFIDENCE_THRESHOLD:-0.5}  # Vosk confidence for Whisper fallback (lowered for better Polish accuracy)
      # Web search (Brave Search API)
      - BRAVE_API_KEY=${BRAVE_API_KEY:-}  # Fallback if secrets disabled
      - SEARCH_RESULTS_LIMIT=${SEARCH_RESULTS_LIMIT:-5}
      # URL validation (Phase 1 - WebView allowlist)
      - ALLOWED_DOMAINS=${ALLOWED_DOMAINS:-}  # Comma-separated custom domains (empty = use defaults)
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Database configuration (Phase 1)
      - DATABASE_ENABLED=${DATABASE_ENABLED:-false}  # Feature flag for Phase 1
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=ai_assistant
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}  # Fallback if secrets disabled
      - POSTGRES_DB=ai_assistant
      # Embeddings
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-nomic-embed-text}
      - EMBEDDING_DIMENSIONS=${EMBEDDING_DIMENSIONS:-384}
      # Cache
      - CACHE_TTL_SECONDS=${CACHE_TTL_SECONDS:-3600}
      # Tool Architecture (Phase 2)
      - NEW_TOOLS_ENABLED=${NEW_TOOLS_ENABLED:-false}  # Feature flag for new BaseTool/ToolRegistry (includes ResearchTool)
      # Learning Systems (Phase 3)
      - LEARNING_ENABLED=${LEARNING_ENABLED:-false}  # Feature flag for ContextEngine/IntentAnalyzer/SuggestionEngine
      # MQTT Topic Configuration (Phase 5)
      - MQTT_TOPIC_VERSION=${MQTT_TOPIC_VERSION:-v1}  # Topic versioning (v1, v2, etc.)
      - MQTT_BASE_PREFIX=${MQTT_BASE_PREFIX:-voice_assistant}  # Topic namespace
      - MQTT_BROKER_URL=${MQTT_BROKER_URL:-mosquitto}  # MQTT broker hostname
      - MQTT_BROKER_PORT=${MQTT_BROKER_PORT:-1883}  # MQTT broker port
      # Client Configuration (React Dashboard)
      - CLIENT_CONFIG_DIR=/data/clients  # Directory for client JSON configs
    # secrets:  # Disabled for local dev (no /run/secrets on macOS)
    #   - ha_token
    #   - openai_api_key
    #   - brave_api_key
    #   - postgres_password
    volumes:
      - ./config:/app/config:ro
      - ./data/clients:/data/clients:ro  # Client configuration files
    depends_on:
      postgres:
        condition: service_healthy
      # Note: homeassistant dependency removed - HA can run externally
      # Use --profile ha if running HA from this compose file
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8080/health', timeout=5).raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Wake-Word Detection Service
  # NOTE: Wake-word service has been moved to a standalone compose file for
  # better multi-platform support (macOS, Linux, RPi).
  #
  # To run wake-word service:
  #   cd ../wake-word-service
  #   docker compose up -d
  #
  # See: wake-word-service/docker-compose.yml
  # See: wake-word-service/.env.example

  # React Dashboard (Multi-Client Architecture)
  # To use a specific client branch:
  #   1. Set REACT_DASHBOARD_BRANCH=client/your_client in .env
  #   2. Or build manually: ./scripts/build-client.sh your_client
  react-dashboard:
    build:
      context: ../react-dashboard
      dockerfile: Dockerfile
      args:
        # Client configuration (passed at build time)
        VITE_CLIENT_ID: ${CLIENT_ID:-default}
        VITE_CLIENT_NAME: ${CLIENT_NAME:-Smart Home Dashboard}
        # Service URLs
        VITE_HA_URL: ${HA_BASE_URL:-http://localhost:8123}
        VITE_GATEWAY_URL: ${GATEWAY_URL:-http://localhost:8080}
        VITE_MQTT_URL: ${MQTT_WS_URL:-ws://localhost:9001}
        # Feature flags
        VITE_FEATURE_VOICE: ${VITE_FEATURE_VOICE:-true}
        VITE_FEATURE_MEDIA: ${VITE_FEATURE_MEDIA:-true}
        VITE_FEATURE_DEBUG: ${VITE_FEATURE_DEBUG:-false}
    container_name: react-dashboard
    ports:
      - "3000:3000"
    depends_on:
      - ai-gateway
      - mosquitto
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# Docker Secrets Configuration (Phase 1) - Disabled for local dev
# To enable secrets on production (Raspberry Pi):
# 1. Create /run/secrets/ directory with proper permissions
# 2. Create individual secret files (ha_token, openai_api_key, brave_api_key, postgres_password)
# 3. Set SECRETS_MANAGER_ENABLED=true in .env
# 4. Uncomment secrets sections in services and below
# secrets:
#   ha_token:
#     file: /run/secrets/ha_token
#   openai_api_key:
#     file: /run/secrets/openai_api_key
#   brave_api_key:
#     file: /run/secrets/brave_api_key
#   postgres_password:
#     file: /run/secrets/postgres_password

# Volumes are now using SSD paths directly
# /mnt/data-ssd/ha-data/ha-config
# /mnt/data-ssd/ha-data/mosquitto/{config,data,log}
