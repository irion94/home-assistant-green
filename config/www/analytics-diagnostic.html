<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Diagnostics</title>
    <style>
        body {
            font-family: monospace;
            background: #1e1e1e;
            color: #e1e1e1;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .section h2 {
            margin-top: 0;
            color: #03a9f4;
        }
        .status {
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
        }
        .success { background: rgba(76, 175, 80, 0.2); border-left: 4px solid #4caf50; }
        .error { background: rgba(244, 67, 54, 0.2); border-left: 4px solid #f44336; }
        .info { background: rgba(3, 169, 244, 0.2); border-left: 4px solid #03a9f4; }
        pre {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #03a9f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
        }
        button:hover {
            background: #0288d1;
        }
    </style>
</head>
<body>
    <h1>üîç Dashboard Diagnostics</h1>

    <div class="section">
        <h2>Environment Information</h2>
        <div id="env-info"></div>
    </div>

    <div class="section">
        <h2>API Tests</h2>
        <button onclick="testAPI()">Test API Connection</button>
        <button onclick="testEntities()">Check Entities</button>
        <button onclick="testHistory()">Test History API</button>
        <button onclick="clearToken(); location.reload();" style="background: var(--danger);">Clear Token & Reload</button>
        <div id="api-results"></div>
    </div>

    <div class="section">
        <h2>HVAC Entity Status</h2>
        <div id="entity-status"></div>
    </div>

    <div class="section">
        <h2>Console Log</h2>
        <pre id="console-log"></pre>
    </div>

    <script>
        const HVAC_ENTITIES = {
            acSypialnia: {
                climate: 'climate.daikin_sypialnia_room_temperature',
                temp: 'sensor.daikin_sypialnia_climatecontrol_room_temperature',
                outdoor: 'sensor.daikin_sypialnia_climatecontrol_outdoor_temperature',
                heating: 'sensor.daikin_sypialnia_climatecontrol_heating_daily_electrical_consumption',
                cooling: 'sensor.daikin_sypialnia_climatecontrol_cooling_daily_electrical_consumption'
            },
            acSalon: {
                climate: 'climate.daikin_salon_room_temperature',
                temp: 'sensor.daikin_salon_climatecontrol_room_temperature',
                outdoor: 'sensor.daikin_salon_climatecontrol_outdoor_temperature',
                heating: 'sensor.daikin_salon_climatecontrol_heating_daily_electrical_consumption',
                cooling: 'sensor.daikin_salon_climatecontrol_cooling_daily_electrical_consumption'
            },
            heatPump: {
                climate: 'climate.pompa_ciepla_room_temperature',
                temp: 'sensor.pompa_ciepla_climatecontrol_room_temperature',
                water: 'sensor.pompa_ciepla_climatecontrol_leaving_water_temperature',
                outdoor: 'sensor.pompa_ciepla_climatecontrol_outdoor_temperature',
                heating: 'sensor.pompa_ciepla_climatecontrol_heating_daily_electrical_consumption',
                cooling: 'sensor.pompa_ciepla_climatecontrol_cooling_daily_electrical_consumption',
                dhw: 'sensor.pompa_ciepla_domestichotwatertank_heating_daily_electrical_consumption'
            }
        };

        let logLines = [];
        let authToken = null;

        // Get authentication token
        function getAuthToken() {
            // Try to get from localStorage first
            let token = localStorage.getItem('ha_access_token');

            if (!token) {
                // Try to get from parent window (if in iframe)
                try {
                    if (window.parent && window.parent !== window) {
                        // When embedded in HA, try to access parent's auth
                        token = window.parent.localStorage?.getItem('hassTokens');
                        if (token) {
                            try {
                                const tokens = JSON.parse(token);
                                token = tokens.access_token;
                                log('Retrieved auth token from parent window');
                            } catch (e) {
                                log(`Failed to parse parent tokens: ${e.message}`, 'error');
                            }
                        }
                    }
                } catch (e) {
                    log(`Cannot access parent window: ${e.message}`, 'info');
                }
            }

            if (!token) {
                // Prompt user for token
                log('No authentication token found', 'error');
                token = prompt(
                    'Please enter a Home Assistant long-lived access token:\n\n' +
                    'Create one at: Profile ‚Üí Security ‚Üí Long-Lived Access Tokens\n\n' +
                    'The token will be stored in localStorage for future use.'
                );

                if (token) {
                    localStorage.setItem('ha_access_token', token);
                    log('Token saved to localStorage');
                }
            } else {
                log('Using stored authentication token');
            }

            return token;
        }

        // Clear stored token (for testing/debugging)
        function clearToken() {
            localStorage.removeItem('ha_access_token');
            authToken = null;
            log('Authentication token cleared');
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const line = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logLines.push(line);
            document.getElementById('console-log').textContent = logLines.join('\n');
            console.log(message);
        }

        function displayEnvInfo() {
            const info = {
                'Current URL': window.location.href,
                'Origin': window.location.origin,
                'Protocol': window.location.protocol,
                'Host': window.location.host,
                'Pathname': window.location.pathname,
                'In iframe': window.self !== window.top,
                'Parent origin': window.self !== window.top ? document.referrer : 'N/A',
                'User Agent': navigator.userAgent,
                'Cookies enabled': navigator.cookieEnabled
            };

            let html = '<table style="width: 100%">';
            for (const [key, value] of Object.entries(info)) {
                html += `<tr><td style="padding: 4px;"><strong>${key}:</strong></td><td style="padding: 4px;">${value}</td></tr>`;
            }
            html += '</table>';
            document.getElementById('env-info').innerHTML = html;

            log('Environment info collected');
        }

        async function testAPI() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<div class="info">Testing API connection...</div>';
            log('Starting API connection test');

            try {
                if (!authToken) {
                    authToken = getAuthToken();
                    if (!authToken) {
                        throw new Error('No authentication token provided');
                    }
                }

                const baseUrl = window.location.origin;
                log(`Making request to: ${baseUrl}/api/states`);

                const response = await fetch(`${baseUrl}/api/states`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`Response status: ${response.status} ${response.statusText}`);
                log(`Response headers: ${JSON.stringify([...response.headers.entries()])}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`Error response body: ${errorText}`, 'error');
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <strong>API Test Failed</strong><br>
                            Status: ${response.status} ${response.statusText}<br>
                            Response: ${errorText}
                        </div>`;
                    return;
                }

                const data = await response.json();
                log(`Received ${data.length} entities`);

                resultsDiv.innerHTML = `
                    <div class="success">
                        <strong>‚úì API Connection Successful</strong><br>
                        Total entities: ${data.length}<br>
                        Sample: ${data.slice(0, 3).map(e => e.entity_id).join(', ')}...
                    </div>`;

            } catch (error) {
                log(`API test error: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="error">
                        <strong>API Test Error</strong><br>
                        ${error.message}
                    </div>`;
            }
        }

        async function testEntities() {
            const resultsDiv = document.getElementById('api-results');
            const statusDiv = document.getElementById('entity-status');
            resultsDiv.innerHTML = '<div class="info">Checking HVAC entities...</div>';
            log('Starting entity check');

            try {
                if (!authToken) {
                    authToken = getAuthToken();
                    if (!authToken) {
                        throw new Error('No authentication token provided');
                    }
                }

                const baseUrl = window.location.origin;
                const response = await fetch(`${baseUrl}/api/states`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const allStates = await response.json();
                log(`Retrieved ${allStates.length} total entities`);

                let html = '<h3>Entity Status:</h3>';
                let foundCount = 0;
                let missingCount = 0;

                // Check all HVAC entities
                for (const [deviceName, entities] of Object.entries(HVAC_ENTITIES)) {
                    html += `<h4>${deviceName}</h4><ul style="margin: 0;">`;

                    for (const [key, entityId] of Object.entries(entities)) {
                        const entity = allStates.find(e => e.entity_id === entityId);
                        if (entity) {
                            foundCount++;
                            html += `<li style="color: #4caf50;">‚úì ${entityId}: ${entity.state} ${entity.attributes.unit_of_measurement || ''}</li>`;
                            log(`Found entity: ${entityId} = ${entity.state}`);
                        } else {
                            missingCount++;
                            html += `<li style="color: #f44336;">‚úó ${entityId}: NOT FOUND</li>`;
                            log(`Missing entity: ${entityId}`, 'error');
                        }
                    }
                    html += '</ul>';
                }

                html += `<div class="info" style="margin-top: 16px;"><strong>Summary:</strong> ${foundCount} found, ${missingCount} missing</div>`;
                statusDiv.innerHTML = html;

                resultsDiv.innerHTML = `
                    <div class="${missingCount === 0 ? 'success' : 'error'}">
                        <strong>${missingCount === 0 ? '‚úì' : '‚ö†'} Entity Check Complete</strong><br>
                        Found: ${foundCount} | Missing: ${missingCount}
                    </div>`;

            } catch (error) {
                log(`Entity check error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="error">
                        <strong>Entity Check Error</strong><br>
                        ${error.message}
                    </div>`;
            }
        }

        async function testHistory() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<div class="info">Testing history API...</div>';
            log('Starting history API test');

            try {
                if (!authToken) {
                    authToken = getAuthToken();
                    if (!authToken) {
                        throw new Error('No authentication token provided');
                    }
                }

                const baseUrl = window.location.origin;
                const testEntity = 'sensor.daikin_sypialnia_climatecontrol_room_temperature';
                const timestamp = new Date(Date.now() - 3600000).toISOString(); // 1 hour ago

                log(`Testing history for: ${testEntity}`);
                const response = await fetch(
                    `${baseUrl}/api/history/period/${timestamp}?filter_entity_id=${testEntity}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );

                log(`History API status: ${response.status}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                log(`Received ${data.length} history arrays`);

                if (data.length > 0 && data[0].length > 0) {
                    log(`First entity has ${data[0].length} data points`);
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <strong>‚úì History API Works</strong><br>
                            Data points: ${data[0].length}<br>
                            Latest: ${data[0][data[0].length - 1].state}
                        </div>`;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="info">
                            <strong>‚ö† History API Works but No Data</strong><br>
                            The entity may not have history recorded yet.
                        </div>`;
                }

            } catch (error) {
                log(`History API error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="error">
                        <strong>History API Error</strong><br>
                        ${error.message}
                    </div>`;
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            log('Diagnostic page loaded');
            displayEnvInfo();
            // Auto-run tests after 1 second
            setTimeout(() => {
                log('Running automatic tests...');
                testAPI();
            }, 1000);
        });

        // Capture any console errors
        window.addEventListener('error', (event) => {
            log(`Uncaught error: ${event.error}`, 'error');
        });
    </script>
</body>
</html>
