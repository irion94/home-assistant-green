# ============================================================================
# SOLARMAN INTEGRATION (Official/Community Hybrid)
# ============================================================================
# Documentation:
# - Official: https://www.home-assistant.io/integrations/solarman/
# - Community: https://github.com/StephanJoubert/home_assistant_solarman
#
# Setup Instructions:
#
# OPTION A: Official Solarman Integration (Cloud API)
# 1. Get API credentials from Solarman platform/app
# 2. Add app_id and app_secret to secrets.yaml
# 3. Configure via UI: Settings → Devices & Services → Add Integration → Solarman
# 4. Enter credentials from secrets.yaml
#
# OPTION B: Community Integration (Local Modbus)
# 1. Install via HACS: Search for "Solarman"
# 2. Direct connection to inverter via RS485/Modbus logger
# 3. Configure logger IP address and inverter model
# 4. More reliable, lower latency, works offline
#
# Note: Community version often preferred for real-time monitoring
# ============================================================================

# Solarman integration is configured via UI

# Example automation for solar production monitoring
automation:
  - id: solarman_high_production_alert
    alias: "Solarman: High Production Alert"
    description: "Notify when solar production exceeds threshold"
    trigger:
      - platform: numeric_state
        entity_id: sensor.solarman_current_power  # Replace with your entity
        above: 5000  # 5 kW
    action:
      - service: persistent_notification.create
        data:
          title: "High Solar Production"
          message: "Current solar production: {{ states('sensor.solarman_current_power') }} W"

  - id: solarman_export_to_grid
    alias: "Solarman: Grid Export Detection"
    description: "Detect when exporting power to grid"
    trigger:
      - platform: numeric_state
        entity_id: sensor.solarman_grid_power  # Replace with your entity
        below: 0  # Negative = export
    action:
      - service: notify.persistent_notification
        data:
          message: "Exporting {{ (states('sensor.solarman_grid_power') | float * -1) | round(2) }} W to grid"

# Example sensors for energy management
sensor:
  - platform: template
    sensors:
      solarman_self_consumption:
        friendly_name: "Solar Self Consumption"
        value_template: >
          {% set production = states('sensor.solarman_current_power') | float(0) %}
          {% set grid = states('sensor.solarman_grid_power') | float(0) %}
          {% if production > 0 %}
            {{ ((1 - (grid / production)) * 100) | round(1) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "%"

      solarman_daily_savings:
        friendly_name: "Daily Solar Savings"
        value_template: >
          {% set daily_production = states('sensor.solarman_daily_energy') | float(0) %}
          {% set price_per_kwh = 0.75 %}  # PLN per kWh
          {{ (daily_production * price_per_kwh) | round(2) }}
        unit_of_measurement: "PLN"
