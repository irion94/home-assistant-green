# Voice Assistant State Management
# Tracks assistant state via MQTT from wake-word service

mqtt:
  sensor:
    - name: "Assistant Status"
      state_topic: "voice_assistant/status"
      icon: mdi:robot

    - name: "Assistant Transcript"
      state_topic: "voice_assistant/text"
      icon: mdi:text

    - name: "Assistant STT Comparison"
      state_topic: "voice_assistant/stt_comparison"
      value_template: "{{ value_json.selected }}"
      json_attributes_topic: "voice_assistant/stt_comparison"
      json_attributes_template: "{{ value_json | tojson }}"
      icon: mdi:compare

  binary_sensor:
    - name: "Assistant Active"
      state_topic: "voice_assistant/status"
      payload_on: "conversation"
      payload_off: "idle"
      device_class: running
      icon: mdi:robot

    - name: "Assistant Listening"
      state_topic: "voice_assistant/status"
      payload_on: "listening"
      payload_off: "idle"
      device_class: sound
      icon: mdi:microphone

    - name: "Assistant Speaking"
      state_topic: "voice_assistant/status"
      payload_on: "speaking"
      payload_off: "idle"
      device_class: sound
      icon: mdi:speaker

    - name: "Assistant Processing"
      state_topic: "voice_assistant/status"
      payload_on: "processing"
      payload_off: "idle"
      device_class: running
      icon: mdi:cog

# Input helpers for manual control
input_boolean:
  assistant_conversation_mode:
    name: "Assistant Conversation Mode"
    icon: mdi:chat

# Automations for assistant state
automation:
  - alias: "Assistant - Start Conversation via Toggle"
    id: assistant_start_conversation_toggle
    trigger:
      - platform: state
        entity_id: input_boolean.assistant_conversation_mode
        to: "on"
    action:
      - service: mqtt.publish
        data:
          topic: "voice_assistant/command"
          payload: "start_conversation"

  - alias: "Assistant - Stop Conversation via Toggle"
    id: assistant_stop_conversation_toggle
    trigger:
      - platform: state
        entity_id: input_boolean.assistant_conversation_mode
        to: "off"
    action:
      - service: mqtt.publish
        data:
          topic: "voice_assistant/command"
          payload: "stop_conversation"

  - alias: "Assistant - Reset Toggle on Conversation End"
    id: assistant_reset_toggle_on_end
    trigger:
      - platform: mqtt
        topic: "voice_assistant/conversation_ended"
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.assistant_conversation_mode

  - alias: "Assistant - Dim Lights When Listening"
    id: assistant_dim_lights_listening
    trigger:
      - platform: state
        entity_id: binary_sensor.assistant_listening
        to: "on"
    condition:
      - condition: state
        entity_id: light.living_room
        state: "on"
    action:
      - service: light.turn_on
        target:
          entity_id: light.living_room
        data:
          brightness_pct: 30

  - alias: "Assistant - Restore Lights After Listening"
    id: assistant_restore_lights
    trigger:
      - platform: state
        entity_id: binary_sensor.assistant_active
        to: "off"
    action:
      - service: light.turn_on
        target:
          entity_id: light.living_room
        data:
          brightness_pct: 100
