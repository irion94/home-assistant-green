---
# Tauron/eLicznik â€“ Prosumer energy bank
# Adds an input_number to store initial bank balance and a template sensor
# that computes the available energy bank from yearly generation/consumption.

# Replace the `123` below with your actual energy meter id.
# Adjust the 0.8 factor if your prosumer settlement ratio is different.

input_number:
  initial_energy_bank:
    name: Initial Energy Bank
    min: 0
    max: 100000000
    step: 1
    mode: box
    unit_of_measurement: kWh

template:
  - sensor:
      - name: Tauron energy bank
        unique_id: tauron_energy_bank
        state_class: total
        device_class: energy
        icon: mdi:home-battery-outline
        unit_of_measurement: "kWh"
        state: >-
          {{ (
              states('input_number.initial_energy_bank') | float(0)
              + (states('sensor.tauron_amiplus_123_yearly_energy_generation') | float(0)) * 0.8
              - (states('sensor.tauron_amiplus_123_yearly_energy_consumption') | float(0))
            ) | round(3) }}
        availability: >-
          {{
            states('sensor.tauron_amiplus_123_yearly_energy_generation') | is_number and
            states('sensor.tauron_amiplus_123_yearly_energy_consumption') | is_number
          }}
