# ============================================================================
# DEVICE DISCOVERY & NETWORK SCANNING
# ============================================================================
# This package enables various discovery protocols to automatically detect
# smart home devices on your network.
#
# Discovery protocols included in default_config:
# - zeroconf (mDNS/Bonjour) - Apple devices, printers, IoT
# - ssdp (UPnP) - Media players, routers, smart TVs
# - dhcp - Network devices via DHCP broadcasts
# - bluetooth - BLE devices (requires Bluetooth adapter)
# - usb - USB devices (Zigbee/Z-Wave dongles)
#
# These are automatically enabled via default_config in configuration.yaml
# This file provides monitoring and logging for discovery events.
# ============================================================================

# ----------------------------------------------------------------------------
# Discovery Event Logging
# ----------------------------------------------------------------------------
automation:
  - id: log_new_device_discovered
    alias: "Discovery: Log New Device"
    description: "Log when a new device is discovered on the network"
    mode: queued
    trigger:
      - platform: event
        event_type: device_registry_updated
        event_data:
          action: create
    action:
      - service: system_log.write
        data:
          message: "New device discovered: {{ trigger.event.data.device_id }}"
          level: info
      - service: persistent_notification.create
        data:
          title: "New Device Discovered"
          message: >
            A new device was added to Home Assistant.
            Check Settings → Devices & Services to configure it.
          notification_id: "new_device_{{ trigger.event.data.device_id }}"

  - id: log_integration_discovered
    alias: "Discovery: Log New Integration"
    description: "Log when a new integration is discovered"
    mode: queued
    trigger:
      - platform: event
        event_type: config_entry_discovered
    action:
      - service: system_log.write
        data:
          message: "New integration discovered: {{ trigger.event.data.domain }}"
          level: info

# ----------------------------------------------------------------------------
# Startup Device Scan
# ----------------------------------------------------------------------------
  - id: scan_devices_on_startup
    alias: "Discovery: Scan on Startup"
    description: "Trigger device discovery scan when HA starts"
    trigger:
      - platform: homeassistant
        event: start
    action:
      - delay:
          seconds: 30  # Wait for network to stabilize
      - service: persistent_notification.create
        data:
          title: "Device Discovery"
          message: "Home Assistant started. Automatic device discovery is active."
          notification_id: discovery_status

# ----------------------------------------------------------------------------
# Bluetooth Discovery (if adapter present)
# ----------------------------------------------------------------------------
  - id: bluetooth_device_discovered
    alias: "Discovery: Bluetooth Device"
    description: "Notify when new Bluetooth device is detected"
    mode: queued
    trigger:
      - platform: event
        event_type: bluetooth_device_detected
    action:
      - service: system_log.write
        data:
          message: "Bluetooth device detected: {{ trigger.event.data.address }}"
          level: debug

# ----------------------------------------------------------------------------
# Network Activity Monitoring
# ----------------------------------------------------------------------------
sensor:
  - platform: template
    sensors:
      discovered_integrations_count:
        friendly_name: "Discovered Integrations"
        value_template: >
          {{ states.sensor
             | selectattr('entity_id', 'search', 'integration_')
             | list | count }}
        unit_of_measurement: "integrations"

      total_devices_count:
        friendly_name: "Total Devices"
        value_template: >
          {{ states | count }}
        unit_of_measurement: "entities"

# ----------------------------------------------------------------------------
# Discovery Protocol Status
# ----------------------------------------------------------------------------
binary_sensor:
  - platform: template
    sensors:
      discovery_active:
        friendly_name: "Discovery Active"
        value_template: >
          {{ states('sensor.discovered_integrations_count') | int(0) > 0 }}
        device_class: connectivity

# ----------------------------------------------------------------------------
# Manual Discovery Helpers
# ----------------------------------------------------------------------------
# Use these scripts to manually trigger discovery scans

script:
  trigger_network_scan:
    alias: "Trigger Network Discovery Scan"
    description: "Manually trigger network device discovery"
    sequence:
      - service: persistent_notification.create
        data:
          title: "Network Scan"
          message: "Manual network discovery scan initiated..."
          notification_id: manual_scan
      # Note: HA continuously scans, but this logs the intent
      - delay:
          seconds: 30
      - service: persistent_notification.create
        data:
          title: "Network Scan Complete"
          message: "Check Settings → Devices & Services for discovered devices."
          notification_id: manual_scan

# ----------------------------------------------------------------------------
# Discovery Configuration Tips
# ----------------------------------------------------------------------------
# 1. Ensure devices are on the same network/VLAN as Home Assistant
# 2. Some devices require specific ports open (UPnP: 1900, mDNS: 5353)
# 3. Check firewall rules if discovery isn't working
# 4. Bluetooth requires compatible adapter (built-in on HA Green)
# 5. For manual integration setup, go to: Settings → Devices & Services → Add Integration
#
# Common discovery-enabled integrations:
# - Philips Hue (mDNS)
# - Google Cast / Chromecast (mDNS)
# - Sonos (SSDP)
# - Samsung TV (SSDP)
# - IKEA Tradfri (mDNS)
# - Xiaomi Gateway (mDNS)
# - TP-Link Kasa (discovery)
# - Shelly devices (mDNS)
# ============================================================================
